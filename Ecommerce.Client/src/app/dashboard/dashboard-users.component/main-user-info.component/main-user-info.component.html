<div class="dashboard-container">
  <!-- Statistics Cards -->
  <div class="row g-4 mb-5">
    <div class="col-xl-2 col-lg-4 col-md-6">
      <div class="stat-card card-shadow">
        <div class="stat-icon stat-total">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <h3>{{ totalUsers | number }}</h3>
          <p>Total Users</p>
        </div>
      </div>
    </div>

    <div class="col-xl-2 col-lg-4 col-md-6">
      <div class="stat-card card-shadow">
        <div class="stat-icon stat-male">
          <i class="fas fa-mars"></i>
        </div>
        <div class="stat-content">
          <h3>{{ maleCount | number }}</h3>
          <p>Male Users</p>
        </div>
      </div>
    </div>

    <div class="col-xl-2 col-lg-4 col-md-6">
      <div class="stat-card card-shadow">
        <div class="stat-icon stat-female">
          <i class="fas fa-venus"></i>
        </div>
        <div class="stat-content">
          <h3>{{ femaleCount | number }}</h3>
          <p>Female Users</p>
        </div>
      </div>
    </div>

    <div class="col-xl-2 col-lg-4 col-md-6">
      <div class="stat-card card-shadow">
        <div class="stat-icon stat-customer">
          <i class="fas fa-user"></i>
        </div>
        <div class="stat-content">
          <h3>{{ customerCount | number }}</h3>
          <p>Customers</p>
        </div>
      </div>
    </div>

    <div class="col-xl-2 col-lg-4 col-md-6">
      <div class="stat-card card-shadow">
        <div class="stat-icon stat-admin">
          <i class="fas fa-user-tie"></i>
        </div>
        <div class="stat-content">
          <h3>{{ adminCount | number }}</h3>
          <p>Admins</p>
        </div>
      </div>
    </div>

    <div class="col-xl-2 col-lg-4 col-md-6">
      <div class="stat-card card-shadow">
        <div class="stat-icon stat-superadmin">
          <i class="fas fa-user-shield"></i>
        </div>
        <div class="stat-content">
          <h3>{{ superAdminCount | number }}</h3>
          <p>Super Admins</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Search & Filter Toolbar -->
  <div class="toolbar card-shadow mb-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <button
          *hasPermission="'Permissions.Account.Create'"
          class="btn btn-success d-flex align-items-center"
          routerLink="/register"
        >
          <i class="fas fa-user-plus me-2"></i>
          Add User
        </button>
        <!-- Filter Toggle -->
        <button
          class="btn btn-outline-success d-flex align-items-center"
          (click)="toggleFilters()"
        >
          <i class="fa fa-filter me-2"></i>
          {{ showFilters ? 'Hide Filters' : 'Show Filters' }}
        </button>

        <!-- Role Filter -->
        @if (showFilters) {
          <div class="role-filter">
            <select
              class="form-select modern-select"
              [(ngModel)]="userParams.role"
              (change)="onRoleSelected(userParams.role || '')"
            >
              @for (option of roleOptions; track option.value) {
                <option [value]="option.value">
                  {{ option.name }}
                </option>
              }
            </select>
          </div>
        }

        <!-- Sort Dropdown -->
        <div class="sort-dropdown">
          <select
            class="form-select modern-select"
            [(ngModel)]="userParams.sort"
            (change)="onSortSelected(userParams.sort)"
          >
            @for (option of sortOptions; track option.value) {
              <option [value]="option.value">
                {{ option.name }}
              </option>
            }
          </select>
        </div>
      </div>

      <!-- Search Bar -->
      <div class="search-bar d-flex flex-grow-1">
        <input
          type="text"
          class="form-control"
          placeholder="Search users by name, email, or username..."
          [(ngModel)]="userParams.search"
          (keyup.enter)="onSearch()"
        />
        <button class="btn btn-dark ms-2" (click)="onSearch()">
          <i class="fa fa-search"></i>
        </button>
        @if (userParams.search || userParams.role) {
          <button class="btn btn-outline-secondary ms-2" (click)="resetSearch()">
            <i class="fa fa-times"></i>
          </button>
        }
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="users-table-container card-shadow">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4 class="fw-bold mb-0">
        <i class="fas fa-users me-2"></i>All Users
      </h4>
      <div class="table-info">
        <span class="badge bg-primary">{{ totalUsers }} total</span>
        <span class="text-muted ms-2">Page {{ pagination.pageIndex }} of {{ totalPages }}</span>
      </div>
    </div>

    <div class="table-responsive">
      @if (loading) {
        <div class="loading-wrapper">
          <div class="loading-spinner"></div>
          <p class="loading-text">Loading users...</p>
        </div>
      } @else {
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th scope="col" class="fw-bold">User</th>
              <th scope="col" class="fw-bold">Contact</th>
              <th scope="col" class="fw-bold">Gender</th>
              <th scope="col" class="fw-bold">Roles</th>
              <th scope="col" class="fw-bold text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            @if (users.length === 0) {
              <tr>
                <td colspan="5" class="text-center py-5 empty-state">
                  <i class="fas fa-user-slash fa-2x mb-3 text-muted"></i>
                  <h5>No Users Found</h5>
                  <p class="text-muted mb-3">Try adjusting your search or filter criteria.</p>
                  <button class="btn btn-outline-dark px-4" (click)="resetFilters()">
                    <i class="fas fa-redo me-2"></i>Reset Filters
                  </button>
                </td>
              </tr>
            } @else {
              @for (user of users; track user.id) {
                <tr class="fade-item">
                  <td>
                    <div class="d-flex align-items-center">
                    <div class="avatar-container me-3">
                    <img
                        [src]="getUserAvatar(user)"
                        [alt]="user.firstName + ' ' + user.lastName"
                        class="avatar"
                        (error)="handleImageError($event)"
                    >
                    </div>
                    <div>
                        <h6 class="mb-0">{{ user.firstName }} {{ user.lastName }}</h6>
                        <small class="text-muted">@{{ user.userName }}</small>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="contact-info">
                      <div class="d-flex align-items-center mb-1">
                        <i class="fas fa-envelope text-muted me-2"></i>
                        <small>{{ user.email }}</small>
                      </div>
                      @if (user.phoneNumber) {
                        <div class="d-flex align-items-center">
                          <i class="fas fa-phone text-muted me-2"></i>
                          <small>{{ user.phoneNumber }}</small>
                        </div>
                      }
                    </div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <i
                        class="fas me-2 {{ getGenderIcon(user.gender) }} {{ getGenderColor(user.gender) }}"
                      ></i>
                      <span class="text-capitalize">{{ user.gender || 'Not specified' }}</span>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex flex-wrap gap-1">
                      @for (role of user.roles; track role) {
                        <span
                          class="badge {{ getRoleBadgeClass(role) }}"
                        >
                          {{ role }}
                        </span>
                      } @empty {
                        <span class="badge bg-secondary">No roles assigned</span>
                      }
                    </div>
                  </td>
                  <td class="text-end">
                    <div class="btn-group" role="group">
                      <button
                        *hasPermission="'Permissions.Roles.Update'"
                        [routerLink]="['roles', user.id]"
                        class="btn btn-sm btn-outline-info"
                        title="Manage Roles"
                      >
                        <i class="fas fa-user-cog"></i>
                      </button>
                      @if (user.isLocked) {
                        <button
                          *hasPermission="'Permissions.Account.Update'"
                          class="btn btn-sm btn-outline-success"
                          title="Unlock User"
                          [disabled]="user.roles.includes('SuperAdmin')"
                          (click)="unlockUser(user)"
                        >
                          <i class="fas fa-unlock"></i>
                        </button>
                      } @else {
                        <button
                          *hasPermission="'Permissions.Account.Update'"
                          class="btn btn-sm btn-outline-warning"
                          title="Lock User"
                          [disabled]="user.roles.includes('SuperAdmin')"
                          (click)="lockUser(user)"
                        >
                          <i class="fas fa-lock"></i>
                        </button>
                      }
                    </div>
                  </td>
                </tr>
              }
            }
          </tbody>
        </table>
      }
    </div>

    <!-- Pagination -->
    @if (!loading && users.length > 0) {
      <div class="card-footer border-top">
        <div class="d-flex justify-content-between align-items-center">
          <div class="text-muted">
            Showing {{ (pagination.pageIndex - 1) * pagination.pageSize + 1 }}
            to {{ getMaxDisplayNumber() }}
            of {{ totalUsers }} users
          </div>
          <div class="pagination-controls">
            <button
              class="btn btn-sm btn-outline-dark me-2"
              [disabled]="pagination.pageIndex === 1"
              (click)="onPageChanged(pagination.pageIndex - 1)"
            >
              <i class="fas fa-chevron-left"></i> Previous
            </button>
            <span class="mx-2">Page {{ pagination.pageIndex }} of {{ totalPages }}</span>
            <button
              class="btn btn-sm btn-outline-dark ms-2"
              [disabled]="pagination.pageIndex === totalPages"
              (click)="onPageChanged(pagination.pageIndex + 1)"
            >
              Next <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    }
  </div>
</div>

